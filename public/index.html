<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; margin-top: 50px; }
        .email-form { margin-bottom: 30px; }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-sent { background-color: #28a745; color: #fff; }
        .status-failed { background-color: #dc3545; color: #fff; }
        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .nav-tabs { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Email Scheduler</h1>
        
        <!-- Email Form -->
        <div class="card email-form">
            <div class="card-body">
                <h5 class="card-title">Schedule New Email</h5>
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="to" class="form-label">To</label>
                        <input type="email" class="form-control" id="to" required>
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="text" class="form-label">Message</label>
                        <textarea class="form-control" id="text" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="scheduledDate" class="form-label">Schedule Date & Time</label>
                        <input type="datetime-local" class="form-control" id="scheduledDate" required 
                               pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}">
                    </div>
                    <button type="submit" class="btn btn-primary">Schedule Email</button>
                </form>
            </div>
        </div>

        <!-- Tabs for different views -->
        <ul class="nav nav-tabs" id="emailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">All Schedules</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="failed-tab" data-bs-toggle="tab" data-bs-target="#failed" type="button">Failed</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">Pending</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <div class="tab-pane fade show active" id="all">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">All Scheduled Emails</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>To</th>
                                        <th>Subject</th>
                                        <th>Scheduled Date</th>
                                        <th>Status</th>
                                        <th>Last Attempt</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="schedulesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="failed">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Failed Emails</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>To</th>
                                        <th>Subject</th>
                                        <th>Error</th>
                                        <th>Last Attempt</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="failedTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pending">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Pending Emails</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>To</th>
                                        <th>Subject</th>
                                        <th>Scheduled Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reschedule Modal -->
    <div class="modal fade" id="rescheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reschedule Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="rescheduleForm">
                        <input type="hidden" id="rescheduleId">
                        <div class="mb-3">
                            <label for="newScheduledDate" class="form-label">New Date & Time</label>
                            <input type="datetime-local" class="form-control" id="newScheduledDate" required
                                   pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="rescheduleEmail()">Reschedule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const formatDate = dateString => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        };

        const getStatusBadge = status => ({
            'pending': '<span class="status-badge status-pending">Pending</span>',
            'sent': '<span class="status-badge status-sent">Sent</span>',
            'failed': '<span class="status-badge status-failed">Failed</span>'
        }[status] || status);

        const validateFutureDate = dateString => new Date(dateString) > new Date();

        const showError = (element, message) => {
            let errorDiv = element.nextElementSibling;
            if (!errorDiv?.classList.contains('error-message')) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                element.parentNode.insertBefore(errorDiv, element.nextSibling);
            }
            errorDiv.textContent = message;
            element.classList.add('is-invalid');
        };

        const clearError = element => {
            const errorDiv = element.nextElementSibling;
            if (errorDiv?.classList.contains('error-message')) errorDiv.remove();
            element.classList.remove('is-invalid');
        };

        const loadData = async (endpoint, tableId) => {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                const tableBody = document.getElementById(tableId);
                tableBody.innerHTML = data.map(schedule => `
                    <tr>
                        <td>${schedule.to}</td>
                        <td>${schedule.subject}</td>
                        ${tableId === 'failedTable' ? `<td>${schedule.error || 'Unknown error'}</td>` : ''}
                        <td>${formatDate(schedule.scheduledDate)}</td>
                        ${tableId !== 'failedTable' ? `<td>${getStatusBadge(schedule.status)}</td>` : ''}
                        <td>${formatDate(schedule.lastAttempt)}</td>
                        <td>
                            ${schedule.status === 'failed' ? `<button class="btn btn-sm btn-warning" onclick="openRescheduleModal('${schedule._id}')">Reschedule</button> ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${schedule._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error(`Error loading ${endpoint}:`, error);
            }
        };

        const loadSchedules = () => loadData('/api/schedules', 'schedulesTable');
        const loadFailedSchedules = () => loadData('/api/schedules/failed', 'failedTable');
        const loadPendingSchedules = () => loadData('/api/schedules/pending', 'pendingTable');

        const openRescheduleModal = id => {
            document.getElementById('rescheduleId').value = id;
            new bootstrap.Modal(document.getElementById('rescheduleModal')).show();
        };

        const handleApiRequest = async (url, options) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error((await response.json()).error || 'Request failed');
                return response;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        };

        const rescheduleEmail = async () => {
            const newScheduledDate = document.getElementById('newScheduledDate');
            if (!validateFutureDate(newScheduledDate.value)) {
                showError(newScheduledDate, 'Please select a future date and time');
                return;
            }
            clearError(newScheduledDate);

            try {
                await handleApiRequest(`/api/schedules/${document.getElementById('rescheduleId').value}/reschedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scheduledDate: newScheduledDate.value })
                });
                bootstrap.Modal.getInstance(document.getElementById('rescheduleModal')).hide();
                [loadSchedules, loadFailedSchedules, loadPendingSchedules].forEach(fn => fn());
                alert('Email rescheduled successfully!');
            } catch (error) {
                alert('Error rescheduling email: ' + error.message);
            }
        };

        const deleteSchedule = async id => {
            if (!confirm('Are you sure you want to delete this scheduled email?')) return;
            try {
                await handleApiRequest(`/api/schedules/${id}`, { method: 'DELETE' });
                [loadSchedules, loadFailedSchedules, loadPendingSchedules].forEach(fn => fn());
                alert('Schedule deleted successfully!');
            } catch (error) {
                alert('Error deleting schedule: ' + error.message);
            }
        };

        document.getElementById('emailForm').addEventListener('submit', async e => {
            e.preventDefault();
            const scheduledDate = document.getElementById('scheduledDate');
            if (!validateFutureDate(scheduledDate.value)) {
                showError(scheduledDate, 'Please select a future date and time');
                return;
            }
            clearError(scheduledDate);

            try {
                await handleApiRequest('/api/schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: document.getElementById('to').value,
                        subject: document.getElementById('subject').value,
                        text: document.getElementById('text').value,
                        scheduledDate: scheduledDate.value
                    })
                });
                alert('Email scheduled successfully!');
                document.getElementById('emailForm').reset();
                loadSchedules();
                loadPendingSchedules();
            } catch (error) {
                alert('Error scheduling email: ' + error.message);
            }
        });

        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', e => {
                const loaders = {
                    'failed-tab': loadFailedSchedules,
                    'pending-tab': loadPendingSchedules,
                    'all-tab': loadSchedules
                };
                loaders[e.target.id]?.();
            });
        });

        ['scheduledDate', 'newScheduledDate'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                validateFutureDate(this.value) ? clearError(this) : showError(this, 'Please select a future date and time');
            });
        });

        loadSchedules();
    </script>
</body>
</html> 